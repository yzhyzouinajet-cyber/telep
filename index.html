<script>
(function(){
  // === CONFIG ===
  const TARGET_PHONE = '0755221314'; // numéro attendu
  const CORRECT = '1798';            // code secret
  const REDIRECT = 'https://sites.google.com/d/1zvWlBSykvZvoG18Gjn02ghG2BxkD2vyK/p/1-FRJK-HhCT25s0XLjAbXvYtJ7KznYyb_/edit';

  // === DOM ===
  const typedEl = document.getElementById('typedNumber');
  const keypad = document.getElementById('keypad');
  const backBtn = document.getElementById('backBtn');
  const clearBtn = document.getElementById('clearBtn');
  const callBtn = document.getElementById('callBtn');
  const overlay = document.getElementById('overlay');
  const codeDisplay = document.getElementById('codeDisplay');
  const vmPad = document.getElementById('vmPad');
  const vmOk = document.getElementById('vmOk');
  const vmCancel = document.getElementById('vmCancel');
  const vmError = document.getElementById('vmError');
  const vmSuccess = document.getElementById('vmSuccess');
  const numErrorBanner = document.getElementById('numError');

  // === state ===
  let typed = '';
  let vmCode = '';

  renderTyped();
  updateCodeDisplay();

  // keypad (compose numéro)
  keypad.addEventListener('click', (e) => {
    const k = e.target.closest('.key');
    if(!k) return;
    typed += k.dataset.key;
    renderTyped();
  });

  backBtn.addEventListener('click', ()=>{ typed = typed.slice(0,-1); renderTyped(); });
  clearBtn.addEventListener('click', ()=>{ typed = ''; renderTyped(); });

  // appel
  callBtn.addEventListener('click', ()=> {
    const normalized = typed.replace(/\D/g,'');
    const targetNorm = TARGET_PHONE.replace(/\D/g,'');
    if(normalized === targetNorm){
      vmCode = '';
      updateCodeDisplay();
      vmError.style.display = 'none';
      vmSuccess.style.display = 'none';
      overlay.style.display = 'flex';
    } else {
      showNumberError();
    }
  });

  // clavier répondeur
  vmPad.addEventListener('click', (e) => {
    const k = e.target.closest('.vm-key');
    if(!k) return;
    if(vmCode.length < 4){
      vmCode += k.dataset.key;
      updateCodeDisplay();
    }
  });

  vmOk.addEventListener('click', ()=> {
    if(vmCode === CORRECT){
      vmError.style.display = 'none';
      vmSuccess.style.display = 'block';
      setTimeout(()=>{ window.location.href = REDIRECT; }, 700);
    } else {
      vmError.textContent = "Code incorrect.";
      vmError.style.display = 'block';
      vmSuccess.style.display = 'none';
      vmCode = '';
      updateCodeDisplay();
    }
  });

  vmCancel.addEventListener('click', ()=>{ overlay.style.display = 'none'; });

  function updateCodeDisplay(){
    const out = vmCode.padEnd(4, '•').split('').map(c => c==='•'?'•':'●').join(' ');
    codeDisplay.textContent = out;
  }
  function renderTyped(){ typedEl.textContent = typed || ' '; }
  function showNumberError(){
    numErrorBanner.style.display = 'block';
    setTimeout(()=>{ numErrorBanner.style.display = 'none'; }, 2000);
  }
})();
</script>
